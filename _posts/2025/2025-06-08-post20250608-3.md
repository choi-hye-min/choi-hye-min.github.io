---
layout: post
title: "gRpc Context ì•ˆì „í•˜ê²Œ ìœ ì§€í•˜ê¸°"
date: 2025-06-08 02:00:00 +0900
categories: [SpringBoot, Kotlin, Armeria, gRPC]
tags: [SpringBoot3, Armeria, gRPC, Coroutine, ContextPropagation]
---

> Spring Boot 3.4.5, Kotlin, Armeria 1.32.5, gRPC í™˜ê²½ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ contextì— ë‹´ì•„ service, repository ë“± ëª¨ë“  ê³„ì¸µì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ë§Œë“œëŠ” ë°©ë²•ì„ ì •ë¦¬í•©ë‹ˆë‹¤.
> íŠ¹íˆ ë¹„ë™ê¸° ì²˜ë¦¬(Coroutine) í™˜ê²½ì—ì„œë„ ì•ˆì „í•˜ê²Œ ìœ ì§€ë˜ë„ë¡ êµ¬í˜„í•©ë‹ˆë‹¤.

#### ë°°ê²½

Spring Bootì™€ gRPCë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì íŠ¸ì—ì„œ, `ë¡œê·¸ì¸ ìœ ì € ì •ë³´`, `íŠ¸ë˜í‚¹ ID`, `ìš”ì²­ í—¤ë” ì •ë³´` ë“±ì„ ëª¨ë“  ê³„ì¸µì—ì„œ ì‚¬ìš©í•˜ê³  ì‹¶ì„ ë•Œê°€ ë§ìŠµë‹ˆë‹¤. ì´ëŸ° ì •ë³´ë¥¼ ì–´ë””ì— ì–´ë–»ê²Œ ì €ì¥í•˜ê³  êº¼ë‚´ ì¨ì•¼ í• ê¹Œìš”?

ArmeriaëŠ” `RequestContext`ë¼ëŠ” êµ¬ì¡°ë¥¼ í†µí•´ ìš”ì²­ ìŠ¤ë ˆë“œ ì•ˆì—ì„œ contextë¥¼ ê³µìœ í•  ìˆ˜ ìˆê²Œ ë„ì™€ì£¼ì§€ë§Œ, Coroutineì²˜ëŸ¼ ìŠ¤ë ˆë“œê°€ ë°”ë€ŒëŠ” í™˜ê²½ì—ì„œëŠ” ë³„ë„ ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì´ ê¸€ì—ì„œëŠ” ê·¸ í•´ê²° ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

---

#### gRPC ìš”ì²­ìì˜ ì •ë³´ë¥¼ Contextì— ì €ì¥í•˜ê¸°

ë¨¼ì € gRPCì—ì„œ ìš”ì²­ìì˜ ë©”íƒ€ë°ì´í„°(metadata) ì •ë³´ë¥¼ ì½ì–´ì„œ Armeriaì˜ `RequestContext`ì— ì €ì¥í•©ë‹ˆë‹¤.

```kotlin
import com.linecorp.armeria.common.RequestContext
import com.linecorp.armeria.server.ServiceRequestContext
import io.grpc.*

class GrpcServerInterceptor : ServerInterceptor {
    override fun <ReqT : Any?, RespT : Any?> interceptCall(
        call: ServerCall<ReqT, RespT>,
        headers: Metadata,
        next: ServerCallHandler<ReqT, RespT>
    ): ServerCall.Listener<ReqT> {
        val userIdKey = Metadata.Key.of("user-id", Metadata.ASCII_STRING_MARSHALLER)
        val userId = headers.get(userIdKey) ?: "anonymous"

        val listener = next.startCall(call, headers)

        val ctx = ServiceRequestContext.current()
        ctx.setAttr(UserContext.USER_ID_KEY, userId)

        return listener
    }
}
```

`user-id`ë¼ëŠ” ë©”íƒ€ë°ì´í„° í‚¤ë¡œ ìœ ì € IDë¥¼ ì¶”ì¶œí•˜ì—¬ contextì— ì €ì¥í•©ë‹ˆë‹¤.

---

#### Contextì— ì €ì¥ëœ ìœ ì € ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” í—¬í¼ í´ë˜ìŠ¤

```kotlin
import com.linecorp.armeria.common.RequestContext
import com.linecorp.armeria.common.util.AttributeKey

object UserContext {
    val USER_ID_KEY: AttributeKey<String> = AttributeKey.valueOf("userId")

    fun currentUserId(): String? {
        return RequestContext.mapCurrent { it.attr(USER_ID_KEY) }.orElse(null)
    }
}
```

ì–´ë””ì„œë“  `UserContext.currentUserId()`ë¥¼ í˜¸ì¶œí•˜ë©´ í˜„ì¬ ìš”ì²­ìì˜ IDë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

#### Service / Repositoryì—ì„œ Context ê°’ ì‚¬ìš©í•˜ê¸°

```kotlin
@Service
class MyService {
    fun handleBusinessLogic() {
        val userId = UserContext.currentUserId()
        println("í˜„ì¬ ìš”ì²­ì: $userId")
    }
}
```

---

#### ë¹„ë™ê¸° Coroutine í™˜ê²½ì—ì„œ Context ìœ ì§€í•˜ê¸°

Armeriaì˜ `RequestContext`ëŠ” ThreadLocal ê¸°ë°˜ì´ë¯€ë¡œ, ì½”ë£¨í‹´ ì „í™˜ ì‹œ ìë™ ì „íŒŒë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì•„ë˜ì™€ ê°™ì´ `CoroutineContext`ì— ë¶™ì—¬ì£¼ëŠ” ë³„ë„ í´ë˜ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.

```kotlin
import com.linecorp.armeria.common.RequestContext
import kotlinx.coroutines.ThreadContextElement
import kotlin.coroutines.AbstractCoroutineContextElement
import kotlin.coroutines.CoroutineContext

class ArmeriaRequestContextElement(
    private val ctx: RequestContext
) : ThreadContextElement<RequestContext>,
    AbstractCoroutineContextElement(Key) {

    companion object Key : CoroutineContext.Key<ArmeriaRequestContextElement>

    private var previous: RequestContext? = null

    override fun updateThreadContext(context: CoroutineContext): RequestContext {
        previous = RequestContext.mapCurrent { it }.orElse(null)
        ctx.makeCurrent()
        return ctx
    }

    override fun restoreThreadContext(context: CoroutineContext, oldState: RequestContext) {
        previous?.makeCurrent()
    }
}
```

---

#### ì½”ë£¨í‹´ ë‚´ì—ì„œ Context ìœ ì§€í•˜ë©° ì‹¤í–‰í•˜ê¸°

```kotlin
import com.linecorp.armeria.server.ServiceRequestContext
import kotlinx.coroutines.withContext

suspend fun <T> withArmeriaContext(block: suspend () -> T): T {
    val ctx = ServiceRequestContext.current()
    return withContext(ArmeriaRequestContextElement(ctx)) {
        block()
    }
}
```

ì‚¬ìš© ì˜ˆì‹œ:

```kotlin
@Service
class MyAsyncService {
    suspend fun asyncBusinessLogic() = withArmeriaContext {
        val userId = UserContext.currentUserId()
        println("ì½”ë£¨í‹´ ë‚´ ìœ ì € ID: $userId")
    }
}
```

---

#### ë§ˆë¬´ë¦¬ ì •ë¦¬

> Armeria ê¸°ë°˜ì˜ Spring Boot + gRPC í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ contextë¡œ ê´€ë¦¬í•˜ë©´, ê³„ì¸µ êµ¬ì¡°ì™€ ìƒê´€ì—†ì´ ì–´ë””ì„œë“  í•„ìš”í•œ ì •ë³´ë¥¼ ì†ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> íŠ¹íˆ Coroutineì„ ì‚¬ìš©í•  ë•ŒëŠ” `RequestContext` ì „íŒŒë¥¼ ìœ„í•œ ì½”ë£¨í‹´ Context ì—°ë™ ì½”ë“œê°€ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.

---

### ğŸ“Œ ì°¸ê³ ìë£Œ

* [Armeria ê³µì‹ ë¬¸ì„œ](https://armeria.dev)
* [gRPC Kotlin ê³µì‹ ê°€ì´ë“œ](https://grpc.io/docs/languages/kotlin/overview/)
* [Coroutine Contextì™€ ThreadLocal](https://kotlinlang.org/docs/coroutine-context-and-dispatchers.html#thread-local-data)
